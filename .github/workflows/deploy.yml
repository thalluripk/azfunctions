name: Deploy Azure Functions

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
    workflow_dispatch:

env:
    DOTNET_VERSION: "8.0"
    ARTIFACT_NAME: "function-app"
    TERRAFORM_VERSION: "1.6.0"

jobs:
    build:
        runs-on: ubuntu-latest
        outputs:
            artifact_name: ${{ env.ARTIFACT_NAME }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: ${{ env.DOTNET_VERSION }}

            - name: Restore dependencies
              run: dotnet restore

            - name: Build
              run: dotnet build --configuration Release --no-restore

            - name: Publish Function App
              run: |
                  dotnet publish -c Release -o ${{ runner.temp }}/publish
                  ls -la ${{ runner.temp }}/publish # This should list .azurefunctions folder

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ env.ARTIFACT_NAME }}
                  path: ${{ runner.temp }}/publish
                  include-hidden-files: true # CRITICAL: Includes the .azurefunctions metadata folder

    terraform-plan:
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: ${{ env.TERRAFORM_VERSION }}

            - name: Terraform Format Check
              working-directory: ./infrastructure
              run: terraform fmt -check -recursive

            - name: Terraform Init
              working-directory: ./infrastructure
              run: terraform init -backend=false

            - name: Terraform Validate
              working-directory: ./infrastructure
              run: terraform validate

    deploy:
        runs-on: ubuntu-latest
        needs: build
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        environment:
            name: production
            url: https://portal.azure.com
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: ${{ env.TERRAFORM_VERSION }}

            - name: Terraform Init
              working-directory: ./infrastructure
              run: terraform init -upgrade -backend-config backend-config.hcl
              env:
                  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
                  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
                  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
                  ARM_ACCESS_KEY: ${{ secrets.TERRAFORM_STATE_ACCESS_KEY }}

            - name: Terraform Plan
              working-directory: ./infrastructure
              run: terraform plan -var-file=terraform.tfvars -out=tfplan
              env:
                  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
                  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
                  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

            - name: Terraform Apply
              working-directory: ./infrastructure
              run: terraform apply -auto-approve tfplan
              env:
                  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
                  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
                  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}

            - name: Download artifact
              uses: actions/download-artifact@v4
              with:
                  name: ${{ env.ARTIFACT_NAME }}
                  path: ${{ runner.temp }}/publish

            - name: Azure Login
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: Deploy to Azure Functions
              uses: Azure/functions-action@v1
              with:
                  app-name: ${{ secrets.FUNCTION_APP_NAME }}
                  package: ${{ runner.temp }}/publish
                  publish-profile: ${{ secrets.FUNCTION_APP_PUBLISH_PROFILE }}

            - name: Run Smoke Tests
              run: |
                  FUNCTION_URL="https://${{ secrets.FUNCTION_APP_NAME }}.azurewebsites.net/api/LoroHttpTrigger"
                  echo "Testing function endpoint: $FUNCTION_URL"
                  curl -X POST "$FUNCTION_URL?code=${{ secrets.FUNCTION_APP_KEY }}" \
                    -H "Content-Type: application/json" \
                    -d '{"name":"test","email":"test@example.com","age":30}' \
                    -w "\nStatus: %{http_code}\n"
                      });

    rollback:
        runs-on: ubuntu-latest
        needs: deploy
        if: failure()
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
              with:
                  terraform_version: ${{ env.TERRAFORM_VERSION }}

            - name: Terraform Init
              working-directory: ./infrastructure
              run: terraform init -backend-config backend-config.hcl
              env:
                  ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
                  ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
                  ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
                  ARM_ACCESS_KEY: ${{ secrets.TERRAFORM_STATE_ACCESS_KEY }}

            - name: Get Previous Deployment
              id: prev_deploy
              run: echo "revision=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT

            - name: Rollback to Previous Version
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}
